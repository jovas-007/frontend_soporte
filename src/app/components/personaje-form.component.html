<form [formGroup]="form" (ngSubmit)="guardar()" class="pf-grid">

  <!-- Columna izquierda: datos -->
  <div class="pf-left">

    <div class="pf-row">
      <mat-form-field appearance="outline" class="pf-field">
        <mat-label>Nombre</mat-label>
        <mat-icon matPrefix>person</mat-icon>
        <input matInput formControlName="nombre" maxlength="100" />
        <mat-error *ngIf="form.controls.nombre.hasError('required')">Requerido</mat-error>
        <mat-error *ngIf="form.controls.nombre.hasError('maxlength')">Máximo 100 caracteres</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="pf-field">
        <mat-label>Especie</mat-label>
        <mat-icon matPrefix>pets</mat-icon>
        <input matInput formControlName="especie" maxlength="100" />
        <mat-error *ngIf="form.controls.especie.hasError('required')">Requerido</mat-error>
        <mat-error *ngIf="form.controls.especie.hasError('maxlength')">Máximo 100 caracteres</mat-error>
      </mat-form-field>
    </div>

    <div class="pf-row">
      <mat-form-field appearance="outline" class="pf-field">
        <mat-label>Género</mat-label>
        <mat-icon matPrefix>badge</mat-icon>
        <mat-select formControlName="genero">
          <mat-option value="" disabled>Selecciona…</mat-option>
          <mat-option value="Femenino">Femenino</mat-option>
          <mat-option value="Masculino">Masculino</mat-option>
        </mat-select>
        <mat-error *ngIf="form.controls.genero.hasError('required')">Requerido</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="pf-field">
        <mat-label>Afiliación</mat-label>
        <mat-icon matPrefix>groups</mat-icon>
        <input matInput formControlName="afiliacion" maxlength="100" />
        <mat-error *ngIf="form.controls.afiliacion.hasError('required')">Requerido</mat-error>
        <mat-error *ngIf="form.controls.afiliacion.hasError('maxlength')">Máximo 100 caracteres</mat-error>
      </mat-form-field>
    </div>

    <div class="pf-row">
      <mat-form-field appearance="outline" class="pf-field">
        <mat-label>Base Ki</mat-label>
        <mat-icon matPrefix>flash_on</mat-icon>
        <input matInput type="number" min="0" step="1"
               inputmode="numeric" pattern="^\d+$"
               formControlName="base_ki" />
        <mat-hint>Valor base de poder</mat-hint>
        <mat-error *ngIf="form.controls.base_ki.hasError('required')">Valor numerico requerido</mat-error>
        <mat-error *ngIf="form.controls.base_ki.hasError('min')">Debe ser ≥ 0</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="pf-field">
        <mat-label>Total Ki</mat-label>
        <mat-icon matPrefix>bolt</mat-icon>
        <input matInput type="number" min="0" step="1"
               inputmode="numeric" pattern="^\d+$"
               formControlName="total_ki" />
        <mat-hint>Máximo registrado</mat-hint>
        <mat-error *ngIf="form.controls.total_ki.hasError('required')">Valor numerico requerido</mat-error>
        <mat-error *ngIf="form.controls.total_ki.hasError('min')">Debe ser ≥ 0</mat-error>
      </mat-form-field>
    </div>

    <mat-form-field appearance="outline" class="pf-field pf-full">
      <mat-label>Descripción</mat-label>
      <mat-icon matPrefix>description</mat-icon>
      <textarea matInput rows="3" formControlName="descripcion"
                placeholder="Detalles relevantes del personaje"></textarea>
      <mat-error *ngIf="form.controls.descripcion.hasError('required')">Requerido</mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" class="pf-field pf-full">
      <mat-label>Imagen por URL</mat-label>
      <mat-icon matPrefix>link</mat-icon>
      <input matInput formControlName="imagen_url" placeholder="https://placehold.co/600x800?text=Goku" />
      <!-- Error de grupo: no hay URL ni archivo -->
      <mat-error *ngIf="form.hasError('imagenRequerida') && (form.dirty || form.touched)">
        Debes proporcionar una imagen: agrega una URL o sube un archivo.
      </mat-error>
    </mat-form-field>

    <div class="pf-actions">
      <button mat-raised-button color="primary" type="submit"
              [disabled]="loading || form.invalid" class="pill-btn">
        {{ personaje ? 'Actualizar' : 'Crear' }}
      </button>
      <button mat-stroked-button type="button" (click)="cancelado.emit()">Cancelar</button>
    </div>
  </div>

  <!-- Columna derecha: archivo + preview -->
  <div class="pf-right">
    <div class="pf-upload card">
      <div class="upload-row">
        <button mat-stroked-button type="button" (click)="fileInput.click()">
          <mat-icon>upload</mat-icon>
          Subir imagen
        </button>
        <input #fileInput type="file" accept="image/*" (change)="seleccionarArchivo($event)" hidden />
        <button *ngIf="file" mat-button color="warn" type="button" (click)="quitarArchivo()">Quitar archivo</button>
      </div>
      <small class="muted">Formatos: JPG, PNG. Tamaño recomendado ~600×800</small>

      <!-- Repite error del grupo cerca del área de subida -->
      <div class="mat-mdc-form-field-error"
           *ngIf="form.hasError('imagenRequerida') && (form.dirty || form.touched)">
        Debes proporcionar una imagen: agrega una URL o sube un archivo.
      </div>
    </div>

    <div class="pf-preview card" *ngIf="preview; else noPreview">
      <img [src]="preview" alt="Previsualización" />
    </div>

    <ng-template #noPreview>
      <div class="pf-preview card empty">
        <mat-icon>image</mat-icon>
        <span>Sin previsualización</span>
      </div>
    </ng-template>
  </div>

</form>
<!--
  Notas:
  - El formulario es un grid con dos columnas (izquierda: datos; derecha: imagen).
  - Cada fila de la columna izquierda es un flexbox con dos campos (o uno si es full width).
  - Los campos usan Angular Material y validaciones reactivas.
  - La imagen se puede subir desde archivo o proporcionar por URL.
  - La previsualización muestra la imagen seleccionada o una placeholder si no hay.
  - Los botones usan estilos "pill" (bordes redondeados).
  -->